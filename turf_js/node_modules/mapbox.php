<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8 />
        <title>A simple map</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
        <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
        <script src="jquery-1.12.1.min.js"></script>
        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <link href="http://code.jquery.com/ui/1.9.0/themes/cupertino/jquery-ui.css" rel="stylesheet" />
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <script src="turf.min.js"></script>
        <script src="numeric-1.2.6.min.js"></script>
        <script src="leaflet.geometryutil.js"></script>
        <!-- <script src="geojson_utils.js"></script> -->
        <script src="require.js"></script>



        <style>
            body {
                background:#404040;
                color:#f8f8f8;
                font:500 20px/26px 'Helvetica Neue', Helvetica, Arial, Sans-serif;
                margin:0;
                padding:0;
                -webkit-font-smoothing:antialiased;
            }
            /**
            * The page is split between map and sidebar - the sidebar gets 1/5, map
            * gets 4/5 of the page. You can adjust this to your personal liking.
            */
            .sidebar {
                width:20%;
            }
            .map {
                border-left:1px solid #fff;
                position:absolute;
                left:20%;
                width:80%;
                top:0;
                bottom:0;
            }
            .pad2 {
                padding:20px;
                -webkit-box-sizing:border-box;
                -moz-box-sizing:border-box;
                box-sizing:border-box;
            }
            #menu {
                list-style-type: none;
            }

            #menu .ui-selecting { background: #404040; }
            #menu .ui-selected { background: #0000FF; color: white; }
        </style>
    </head>

    <body>

        <div id class='sidebar pad2'>Campers

            <?php
                $file = fopen("campers.csv","r");
                $campers = array();

                while(!feof($file)) {
                    $row = fgetcsv($file);
                    array_push($campers, $row);
                }

                fclose($file);
                echo '<ul id="menu">';
                $num = 0;
                foreach ($campers as $c) {
                    echo '<li data-frontage = "'.$c[1].'" data-depth="'.$c[2].'">'.$c[0].'</li>';
                    $num = $num+1;
                }
                echo '</ul>';

            ?>
        </div>
        <div id='map' class='map pad2'>Map</div>
        <script type= "text/javascript">


            L.mapbox.accessToken = 'pk.eyJ1Ijoic2hhbmVqb3NpYXMiLCJhIjoiY2lwczZwYzVkMDAxN2h0bTJ4M3Fpa3JzZyJ9.oJQvdNDebSyjfrhPOE2xAw';
            var map = L.mapbox.map('map', 'shanejosias.0fm4hn5h');
            

            $( "#menu" ).selectable({
                selected: function( event, ui ) {
                            $( ".ui-selected", this ).each(function() {
                                    var index = $( "#menu li" ).index( this );


                                    // This obtains the relevent properties
                                    var el = document.querySelector('.ui-selected');
                                    // alert(el.dataset.frontage);

                                    var polyline;
                                    var first = 1;
                                    var relative = 0.0002;
                                    var features = map.featureLayer._geojson.features;
                                    // map.featureLayer._geojson.features = undefined;
                                    // features = undefined;

                                    map.on('mousemove', function(e) {

                                        var xc = e.latlng.lat;
                                        var yc = e.latlng.lng;
                                        var center = turf.point([yc,xc]);
                                        // console.log(e );
                                        var poly;
                                        var line_points;
                                        var line_points2;

                                        var pts;
                                        for (var i = 0; i < features.length; i++) {

                                            poly = turf.polygon(features[i].geometry.coordinates);
                                            // console.log(poly);
                                            if (turf.inside(center, poly)) {

                                                var lineArr = []
                                                var val = 0;
                                                for (var j = 1; j < poly.geometry.coordinates[0].length-1; j++) {
                                                    one1 = poly.geometry.coordinates[0][j-1][0];
                                                    one2 = poly.geometry.coordinates[0][j-1][1];
                                                    two3 =  poly.geometry.coordinates[0][j+1][0]
                                                    two4 =  poly.geometry.coordinates[0][j+1][1]
                                                    // console.log(one);

                                                    lineArr.push(turf.linestring([[one1, one2], [two3, two4]]));
                                                    
                                                }

                                                // pts  = turf.featurecollection(ptsArr);
                                                // var nearest1 = turf.nearest(center, pts);

                                                var before;
                                                var after;
                                                // ptsArr = []
                                                val = 0;
                                                
                                                var index;
                                                var theta_deg;
                                                var intersection_pts_array = [];
                                                var minimum_index = 0;
                                                var minimum_distance = Number.MAX_VALUE;
                                                for (index = 0; index*15 < 360; index++) {

                                                
                                                    // console.log(index);
                                                    // theta_deg = 30*index - 360;
                                                    
                                                    theta_deg = 15*index;
                                                    

                                                    // console.log(bearing_np);

                                                    var theta_rad = (Math.PI*theta_deg)/180;
                                                    var la1 = (Math.PI*yc)/180;
                                                    var lo1 = (Math.PI*xc)/180;
                                                    var d = 0.5;
                                                    var R = 6371;
                                                    var Ad = d/R;
                                                    
                                                    var la2 = Math.asin(Math.sin(la1)*Math.cos(Ad) + Math.cos(la1)*Math.sin(Ad)*Math.cos(theta_rad));
                                                    var lo2 = lo1 + Math.atan2(Math.sin(theta_rad)*Math.sin(Ad)*Math.cos(la1), Math.cos(Ad)-Math.sin(la1)*Math.sin(la2));
                                                    var lat2 = la2 * (180/Math.PI);
                                                    var lon2 = lo2 * (180/Math.PI);

                                                    console.log([lon2,lat2]);

                                                    var test_line = turf.linestring([[yc,xc],[lon2,lat2]]);
                                                    // console.log(test_line);
                                                    // var gju = require(['geojson-utils']);
                                                    var k ;
                                                    var dist;
                                                    // console.log(gju);
                                                    for (k = 0; k < lineArr.length; k++  ) {
                                                        var line_intersect = lineStringsIntersect(lineArr[k], test_line);
                                                        if (line_intersect != false ) {
                                                            // console.log(line_intersect);
                                                        // console.log(k);

                                                            var temp_point = turf.point([line_intersect[0].coordinates[0],line_intersect[0].coordinates[1]]);
                                                            dist = turf.distance(center, temp_point);
                                                            intersection_pts_array.push(temp_point);
                                                            if (dist < minimum_distance) {
                                                                minimum_index = index;
                                                                minimum_distance = dist;
                                                                // console.log(minimum_distance);
                                                            }
                                                            break;
                                                        }
                                                    }
                                                    // var intersect = turf.intersect(test_line,poly);
                                                    // console.log(intersect);
                                                    // var point_intersection = turf.point(intersect.geometry.coordinates[1]);
                                                    
                                                    // intersection_pts_array.push(intersect);
                                                    // console.log(intersection_pts_array);
                                                    // console.log(minimum_index);
                                                    // var point1 = intersection_pts_array[3].geometry.coordinates[0];
                                                    // var point2 = intersection_pts_array[3].geometry.coordinates[1];
                                                    // // console.log(point1);
                                                    //  line_points = [
                                                    //     [point1,point2]
                                                    //     // [point2[1], point2[0]]
                                                    //     // [lat2, lon2]
                                                    //     // [xc-4*relative, yc]
                                                    // ];

                                                    // polyline = L.polygon(line_points, polyline_options);
                                                    // map.addLayer(polyline);

                                                    // if (dist < minimum_distance) {
                                                    //     minimum_index = index;
                                                    //     minimum_distance = dist;
                                                    //     // console.log(minimum_distance);
                                                    // }
                                                }

                                                // console.log(intersection_pts_array);

                                                // console.log(minimum_index);


                                                 // var test_line = turf.linestring([line_points2[0], line_points2[1], line_points2[0]]);
                                                 // console.log(test_line);
                                                 // var intersect = turf.intersect(test_line,poly);
                                                 // console.log(intersect);
                                                 // console.log('----------');
                                                // bearing calculations

                                               

                                                // var bearing_np_radians = (Math.PI*bearing_np)/180;
                                                // var la1 = (Math.PI*p1.geometry.coordinates[1])/180;
                                                // var lo1 = (Math.PI*p1.geometry.coordinates[0])/180;
                                                // var d = frontage_distance;
                                                // var R = 6371;
                                                // var Ad = d/R;
                                                
                                                // var la2 = Math.asin(Math.sin(la1)*Math.cos(Ad) + Math.cos(la1)*Math.sin(Ad)*Math.cos(bearing_np_radians));
                                                // var lo2 = lo1 + Math.atan2(Math.sin(bearing_np_radians)*Math.sin(Ad)*Math.cos(la1), Math.cos(Ad)-Math.sin(la1)*Math.sin(la2));
                                                // var lat2 = la2 * (180/Math.PI);
                                                // var lon2 = lo2 * (180/Math.PI);

                                                console.log(min);


                                                var point1 = intersection_pts_array[minimum_index].geometry.coordinates[0];
                                                var point2 = intersection_pts_array[minimum_index].geometry.coordinates[1];

                                                // console.log(point1);

                                                line_points = [
                                                    [point1,point2] 
                                                    // [point2[1],pont2[0]],
                                                    // [lat2, lon2]
                                                    // [xc-4*relative, yc]
                                                ];
                                                // line_points2 = [
                                                //     [point.geometry.coordinates[0], point.geometry.coordinates[1]  ], 
                                                //     // [p2.geometry.coordinates[0],p2.geometry.coordinates[1] ],
                                                //     // [lon2, lat2]
                                                //     // [xc-4*relative, yc]
                                                // ];
                                                // line_points = [
                                                //     [xc, yc-2*relative],
                                                //     [xc, yc + 2*relative]
                                                //     // [xc + 4*relative, yc+4*relative]
                                                //     // [xc-4*relative, yc]
                                                // ];
                                                // line_points2 = [
                                                //     [yc-2*relative, xc],
                                                //     [yc+2*relative, xc ]
                                                //     // [yc + 4*relative, xc + 4*relative]
                                                //     // [xc-4*relative, yc]
                                                // ];
                                                
                                                break;
                                            } else {
                                                relative = 0.00005;
                                                
                                                line_points = [
                                                    [xc, yc-2*relative],
                                                    [xc, yc + 2*relative]
                                                    // [xc + 4*relative, yc+4*relative]
                                                    // [xc-4*relative, yc]
                                                ];
                                                line_points2 = [
                                                    [yc-2*relative, xc],
                                                    [yc+2*relative, xc ]
                                                    // [yc + 4*relative, xc + 4*relative]
                                                    // [xc-4*relative, yc]
                                                ];
                                            }
                                        }



                                        var polyline_options = {
                                            color: '#404040',
                                            opacity : 1,
                                            // weight : 20
                                        };



                                        if (first == 1) {
                                            polyline = L.polygon(line_points, polyline_options);
                                            map.addLayer(polyline);
                                            first = 0;
                                        } else {
                                            map.removeLayer(polyline);
                                            polyline = L.polygon(line_points, polyline_options);
                                            map.addLayer(polyline);
                                        }   
                                    });

                            });


                        }
            });

            $( "#menu" ).on("selectableselected", function( event, ui ) {} );
            function lineStringsIntersect(l1, l2) {
                    var intersects = [];
                    for (var i = 0; i <= l1.geometry.coordinates.length - 2; ++i) {
                      for (var j = 0; j <= l2.geometry.coordinates.length - 2; ++j) {
                        var a1 = {
                          x: l1.geometry.coordinates[i][1],
                          y: l1.geometry.coordinates[i][0]
                        },
                          a2 = {
                            x: l1.geometry.coordinates[i + 1][1],
                            y: l1.geometry.coordinates[i + 1][0]
                          },
                          b1 = {
                            x: l2.geometry.coordinates[j][1],
                            y: l2.geometry.coordinates[j][0]
                          },
                          b2 = {
                            x: l2.geometry.coordinates[j + 1][1],
                            y: l2.geometry.coordinates[j + 1][0]
                          },
                          ua_t = (b2.x - b1.x) * (a1.y - b1.y) - (b2.y - b1.y) * (a1.x - b1.x),
                          ub_t = (a2.x - a1.x) * (a1.y - b1.y) - (a2.y - a1.y) * (a1.x - b1.x),
                          u_b = (b2.y - b1.y) * (a2.x - a1.x) - (b2.x - b1.x) * (a2.y - a1.y);
                        if (u_b != 0) {
                          var ua = ua_t / u_b,
                            ub = ub_t / u_b;
                          if (0 <= ua && ua <= 1 && 0 <= ub && ub <= 1) {
                            intersects.push({
                              'type': 'Point',
                              'coordinates': [a1.x + ua * (a2.x - a1.x), a1.y + ua * (a2.y - a1.y)]
                            });
                          }
                        }
                      }
                    }
                    if (intersects.length == 0) intersects = false;
                    return intersects;
                  }

        </script>
    </body>
</html>